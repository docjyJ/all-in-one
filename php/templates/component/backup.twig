<section>
    {% if is_instance_restore_attempt == false %}
        {% if borg_backup_host_location != '' and borg_restore_password != '' %}
            {% if borg_backup_mode in ['test', 'check'] %}
                {% if backup_exit_code > 0 %}
                    <span class="status error"></span> Last {{ borg_backup_mode }} failed! (<a href="/api/docker/logs?id=nextcloud-aio-borgbackup" target="_blank" rel="noopener">Logs</a>)<br /><br />
                    {% if borg_backup_mode == 'test' %}
                        Please adjust the path and/or the encryption password in order to make it work!<br><br>
                    {% elseif borg_backup_mode == 'check' %}
                      <p>The backup archive seems to be corrupt. Please try to use a different intact backup archive or try to fix it by following <a href="https://borgbackup.readthedocs.io/en/stable/faq.html#i-get-an-integrityerror-or-similar-what-now"><strong>this documentation</strong></a></p>
                        <details>
                            <summary>Reveal repair option</summary>
                          <p>Below is the option to repair the integrity of your backup. <strong>Please note:</strong> Please only use this after you have read the documentation above! (It will run the command 'borg check --repair' for you.)</p>
                            <form method="POST" action="/api/docker/backup-check-repair" class="xhr">
                                <input type="hidden" name="{{csrf.keys.name}}" value="{{csrf.name}}">
                                <input type="hidden" name="{{csrf.keys.value}}" value="{{csrf.value}}">
                                <input type="submit" value="Check and repair backup integrity" onclick="return confirm('Check and repair backup integrity? Are you sure that you want to check and repair the backup integrity? This should only be done after reading the mentioned documentation.')"/>
                            </form>
                        </details>
                    {% endif %}
                {% elseif backup_exit_code == 0 %}
                    <span class="status success"></span> Last {{ borg_backup_mode }} successful! (<a href="/api/docker/logs?id=nextcloud-aio-borgbackup" target="_blank" rel="noopener">Logs</a>)<br /><br />
                    {% if borg_backup_mode == 'test' %}
                      <p>Feel free to check the integrity of the backup archive below before starting the restore process in order to make ensure that the restore will work. This can take a long time though depending on the size of the backup archive and is thus not required.</p>
                        <form method="POST" action="/api/docker/backup-check" class="xhr">
                            <input type="hidden" name="{{csrf.keys.name}}" value="{{csrf.name}}">
                            <input type="hidden" name="{{csrf.keys.value}}" value="{{csrf.value}}">
                            <input type="submit" value="Check backup integrity"/><br/>
                        </form>
                    {% endif %}
                  <p>Choose the backup that you want to restore and click on the button below to restore the selected backup. This will restore the whole AIO instance. Please note that the current AIO passphrase will be kept and the previous AIO passphrase will not be restored from backup!</p>
                    <p><strong>Please note:</strong> If the backup that you want to restore contained any <a href="https://github.com/nextcloud/all-in-one/tree/main/community-containers#community-containers">community container</a>, but you did not specify the same community containers via environmental variable while creating this new AIO instance, you need to restore the same backup a second time after this attempt so that the community container data is also correctly restored.</p>
                    <form method="POST" action="/api/docker/restore" class="xhr" id="restore_selection">
                        <input type="hidden" name="{{csrf.keys.name}}" value="{{csrf.name}}">
                        <input type="hidden" name="{{csrf.keys.value}}" value="{{csrf.value}}">
                        <select id="selected_restore_time" name="selected_restore_time" form="restore_selection">
                            {% for restore_time in backup_times %}
                                <option value="{{ restore_time }}">{{ restore_time }} UTC</option>
                            {% endfor %}
                        </select>
                        <input type="submit" value="Restore selected backup"/>
                    </form>
                {% endif %}
            {% elseif borg_backup_mode == 'restore' %}
                {% if backup_exit_code > 0 %}
                    <p><span class="status error"></span> Last restore failed! (<a href="/api/docker/logs?id=nextcloud-aio-borgbackup" target="_blank" rel="noopener">Logs</a>)</p>
                    <p>The restore process has unexpectedly failed! Please adjust the path and encryption password, test it and try to restore again!</p>
                {% endif %}
            {% endif %}
        {% endif %}

        {% if borg_backup_host_location == '' or borg_restore_password == '' or borg_backup_mode not in ['test', 'check', ''] or backup_exit_code > 0 %}


            <h2>Restore former AIO instance from backup</h2>
            <p>You can alternatively restore a former AIO instance from backup.</p>

            <p>Please enter the location of the backup archive on your host and the encryption password of the backup archive below:</p>
            <form method="POST" action="/api/configuration" class="xhr">
                <input type="text" name="borg_restore_host_location" value="{{borg_backup_host_location}}" placeholder="/mnt/backup"/>
                <input type="text" name="borg_restore_password" value="{{borg_restore_password}}" placeholder="encryption password"/>
                <input type="hidden" name="{{csrf.keys.name}}" value="{{csrf.name}}">
                <input type="hidden" name="{{csrf.keys.value}}" value="{{csrf.value}}">
                <input type="submit" value="Submit location and encryption password" />
            </form>

            <div>{{ include('includes/backup-dirs.twig') }}</div>
            <p>⚠️ Please note that the backup archive must be located in a subfolder of the folder that you enter here and the subfolder which contains the archive must be named 'borg', or the backup container will not be able to find the backup archive!</p>
        {% endif %}
    {% else %}


        <h2>Restore former AIO instance from backup</h2>
        <p>You can alternatively restore a former AIO instance from backup.</p>
        <p><strong>Everything set!</strong> Click on the button below to test the path and encryption password:</p>
        <form method="POST" action="/api/docker/backup-test" class="xhr">
            <input type="hidden" name="{{csrf.keys.name}}" value="{{csrf.name}}">
            <input type="hidden" name="{{csrf.keys.value}}" value="{{csrf.value}}">
            <input type="submit" value="Test path and encryption password"/><br/>
        </form>
    {% endif %}
</section>
